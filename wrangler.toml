name = "api-proxy"
main = "build/index.js"
compatibility_date = "2026-02-27"

routes = [
    { pattern = "api-proxy.admice.com", custom_domain = true }
]

[build]
command = "cargo install -q worker-build && worker-build --release"

[observability.logs]
enabled = false

[placement]
mode = "smart"

# Secrets (set via: wrangler secret put AUTH_TOKEN)
# AUTH_TOKEN - Authentication bearer token for API requests

# Durable Objects for 8 global regions
# Each region has 10 instances (0-9) for 10x concurrency via hash-based distribution
# DOs are named: {region}-processor-{0-9} (e.g., wnam-processor-0, wnam-processor-1, etc.)
# Western North America
[[durable_objects.bindings]]
name = "WNAM_PROCESSOR"
class_name = "WNAMProcessor"
script_name = "api-proxy"

# Eastern North America
[[durable_objects.bindings]]
name = "ENAM_PROCESSOR"
class_name = "ENAMProcessor"
script_name = "api-proxy"

# Western Europe (EU jurisdiction)
[[durable_objects.bindings]]
name = "WEUR_PROCESSOR"
class_name = "WEURProcessor"
script_name = "api-proxy"

# Eastern Europe (EU jurisdiction)
[[durable_objects.bindings]]
name = "EEUR_PROCESSOR"
class_name = "EEURProcessor"
script_name = "api-proxy"

# Asia-Pacific
[[durable_objects.bindings]]
name = "APAC_PROCESSOR"
class_name = "APACProcessor"
script_name = "api-proxy"

# Oceania
[[durable_objects.bindings]]
name = "OC_PROCESSOR"
class_name = "OCProcessor"
script_name = "api-proxy"

# Africa
[[durable_objects.bindings]]
name = "AF_PROCESSOR"
class_name = "AFProcessor"
script_name = "api-proxy"

# Middle East
[[durable_objects.bindings]]
name = "ME_PROCESSOR"
class_name = "MEProcessor"
script_name = "api-proxy"

# Durable Object migrations
# Named DOs are created on-demand when first accessed
# No explicit migration needed for hash-based distribution
[[migrations]]
tag = "v1"
new_sqlite_classes = [
    "WNAMProcessor",
    "ENAMProcessor",
    "WEURProcessor",
    "EEURProcessor",
    "APACProcessor",
    "OCProcessor",
    "AFProcessor",
    "MEProcessor",
]
